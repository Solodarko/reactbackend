/**
 * Demonstrate the exact user flow:
 * 1. Admin dashboard shows QR that refreshes every 5 minutes
 * 2. Student scans â†’ Scanner decodes JSON payload  
 * 3. Backend checks timestamp validity
 * 4. Valid â†’ mark attendance, Expired â†’ reject
 */

const { parseAndValidateQR } = require('../utils/qrCodeValidator');

// 1. Admin dashboard generates QR (refreshes every 5 minutes)
function adminDashboardGenerateQR() {
  const now = Date.now();
  const qrPayload = {
    id: `attendance_${now}`,
    type: 'attendance_check',
    timestamp: now,
    expiresAt: new Date(now + 5 * 60 * 1000).toISOString(), // 5 minutes
    checksum: Buffer.from(`attendance_${now}_${now}`, 'utf8').toString('base64'),
    location: 'admin_dashboard',
    user: {
      userId: 'admin123',
      username: 'prof_johnson',
      email: 'prof.johnson@university.edu',
      role: 'admin',
      studentId: '11111',
      firstName: 'Dr. Sarah',
      lastName: 'Johnson',
      fullName: 'Dr. Sarah Johnson',
      department: 'Computer Science'
    }
  };
  
  console.log('ğŸ¯ ADMIN DASHBOARD: QR Code Generated');
  console.log('   ğŸ“„ JSON Payload:', JSON.stringify(qrPayload, null, 2));
  console.log('   â° Expires at:', qrPayload.expiresAt);
  console.log('   ğŸ”„ Will refresh in 5 minutes...\n');
  
  return qrPayload;
}

// 2. Student scans QR â†’ Scanner decodes JSON payload
function studentScanQR(qrPayload) {
  console.log('ğŸ“± STUDENT SCANS QR CODE');
  console.log('   ğŸ” Scanner decoding JSON payload...');
  console.log('   ğŸ“‹ Decoded QR ID:', qrPayload.id);
  console.log('   ğŸ“… Timestamp:', new Date(qrPayload.timestamp).toLocaleString());
  console.log('   â³ Expires at:', new Date(qrPayload.expiresAt).toLocaleString());
  console.log('   ğŸ‘¨â€ğŸ« Generated by:', qrPayload.user.fullName);
  return qrPayload;
}

// 3. Backend checks timestamp validity
function backendValidateTimestamp(qrPayload) {
  console.log('\nğŸ–¥ï¸  BACKEND VALIDATION');
  console.log('   â° Checking if QR timestamp is still valid...');
  
  const validation = parseAndValidateQR(JSON.stringify(qrPayload));
  
  if (validation.isValid) {
    const now = new Date();
    const expiresAt = new Date(qrPayload.expiresAt);
    const minutesRemaining = Math.ceil((expiresAt - now) / (1000 * 60));
    
    console.log('   âœ… QR code is VALID!');
    console.log('   â±ï¸  Time remaining:', minutesRemaining, 'minutes');
    return { valid: true, validation };
  } else {
    console.log('   âŒ QR code is EXPIRED!');
    console.log('   ğŸ’¬ Error:', validation.message);
    return { valid: false, validation };
  }
}

// 4. Valid â†’ mark attendance, Expired â†’ reject
function processAttendance(isValid, validation) {
  console.log('\nğŸ“ ATTENDANCE PROCESSING');
  
  if (isValid) {
    // Simulate successful attendance marking
    const studentId = '67890'; // Scanning student
    const attendanceRecord = {
      StudentID: parseInt(studentId),
      Date: new Date(),
      Status: 'Present',
      attendanceType: 'qr_scan',
      qrCodeInfo: {
        qrId: validation.extractedData.qrCodeId,
        generatedBy: validation.extractedData.generatedBy.username,
        location: validation.extractedData.location
      }
    };
    
    console.log('   âœ… ATTENDANCE MARKED!');
    console.log('   ğŸ‘¨â€ğŸ“ Student ID:', attendanceRecord.StudentID);
    console.log('   ğŸ“… Date:', attendanceRecord.Date.toLocaleString());
    console.log('   ğŸ“Š Status:', attendanceRecord.Status);
    console.log('   ğŸ·ï¸  QR Generated by:', attendanceRecord.qrCodeInfo.generatedBy);
    console.log('   ğŸ’¾ Stored in MongoDB âœ“');
    
  } else {
    console.log('   âŒ ATTENDANCE REJECTED!');
    console.log('   ğŸš« Reason: QR code expired');
    console.log('   ğŸ’¡ Student must scan a fresh QR code');
  }
}

// Demo the complete flow
function demoCompleteFlow() {
  console.log('ğŸ¬ DEMONSTRATING COMPLETE QR ATTENDANCE FLOW\n');
  console.log('=' .repeat(60));
  
  // Step 1: Admin dashboard generates QR
  const qrPayload = adminDashboardGenerateQR();
  
  // Step 2: Student scans and decodes
  const scannedPayload = studentScanQR(qrPayload);
  
  // Step 3: Backend validates timestamp
  const { valid, validation } = backendValidateTimestamp(scannedPayload);
  
  // Step 4: Process attendance based on validity
  processAttendance(valid, validation);
  
  console.log('\n' + '=' .repeat(60));
  console.log('ğŸ FLOW COMPLETE!\n');
}

// Demo with expired QR
function demoExpiredQR() {
  console.log('ğŸ¬ DEMONSTRATING EXPIRED QR REJECTION\n');
  console.log('=' .repeat(60));
  
  // Create an expired QR (6 minutes ago)
  const expiredTime = Date.now() - (6 * 60 * 1000);
  const expiredQR = {
    id: `attendance_${expiredTime}`,
    type: 'attendance_check',
    timestamp: expiredTime,
    expiresAt: new Date(expiredTime + 5 * 60 * 1000).toISOString(),
    checksum: Buffer.from(`attendance_${expiredTime}_${expiredTime}`, 'utf8').toString('base64'),
    location: 'admin_dashboard',
    user: { username: 'prof_johnson', fullName: 'Dr. Sarah Johnson' }
  };
  
  console.log('ğŸ¯ ADMIN DASHBOARD: Generated QR 6 minutes ago (expired)');
  console.log('ğŸ“± STUDENT SCANS: Old QR code');
  
  const { valid, validation } = backendValidateTimestamp(expiredQR);
  processAttendance(valid, validation);
  
  console.log('\n' + '=' .repeat(60));
  console.log('ğŸ EXPIRED QR REJECTED!\n');
}

// Run demonstrations
if (require.main === module) {
  demoCompleteFlow();
  console.log('\n');
  demoExpiredQR();
}

module.exports = { demoCompleteFlow, demoExpiredQR };
