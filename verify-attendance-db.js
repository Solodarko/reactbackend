/**
 * Verify Attendance Database Records
 * This script checks if QR attendance records are properly stored with all required fields
 */

require('dotenv').config();
const mongoose = require('mongoose');
const Attendance = require('./models/Attendance');
const Student = require('./models/Student');

async function verifyAttendanceRecords() {
  console.log('ðŸ” Verifying Attendance Database Records\n');

  try {
    // Connect to database
    const dbUri = process.env.MONGODB_URI;
    console.log('ðŸ”„ Connecting to MongoDB...');
    await mongoose.connect(dbUri);
    console.log('âœ… Connected to MongoDB\n');

    // Get recent QR scan attendance records (last 24 hours)
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    console.log('ðŸ“Š Fetching QR attendance records from last 24 hours...');
    const qrAttendanceRecords = await Attendance.find({
      Date: { $gte: yesterday },
      attendanceType: 'qr_scan',
      'qrScannerLocation.coordinates.latitude': { $exists: true }
    });

    console.log(`ðŸ“„ Found ${qrAttendanceRecords.length} QR attendance records\n`);

    if (qrAttendanceRecords.length === 0) {
      console.log('âš ï¸ No QR attendance records found in the last 24 hours.');
      console.log('   Run the QR test script first: node test-qr-realtime.js\n');
      return false;
    }

    // Verify each record has required fields
    let validationErrors = 0;
    
    qrAttendanceRecords.forEach((record, index) => {
      console.log(`ðŸ” Validating Record ${index + 1}:`);
      console.log(`   ðŸ“„ ID: ${record._id}`);
      console.log(`   ðŸ‘¤ Student ID: ${record.StudentID || 'N/A'}`);
      console.log(`   ðŸ“… Date: ${record.Date?.toLocaleString()}`);
      console.log(`   âœ… Status: ${record.Status}`);
      console.log(`   ðŸŽ¯ Attendance Type: ${record.attendanceType}`);
      
      // Check QR Scanner Location
      if (record.qrScannerLocation?.coordinates?.latitude && record.qrScannerLocation?.coordinates?.longitude) {
        console.log(`   ðŸ“ QR Location: ${record.qrScannerLocation.coordinates.formatted?.latitude}, ${record.qrScannerLocation.coordinates.formatted?.longitude}`);
        console.log(`   ðŸ“ Distance: ${record.qrScannerLocation.distance || 'N/A'}m`);
        console.log(`   ðŸŽ¯ GPS Accuracy: ${record.qrScannerLocation.accuracy || 'N/A'}m`);
      } else {
        console.log('   âŒ Missing QR scanner location coordinates');
        validationErrors++;
      }
      
      // Check Location Verification
      if (record.locationVerification) {
        console.log(`   ðŸ” Verification Method: ${record.locationVerification.method}`);
        console.log(`   âœ… Verification Status: ${record.locationVerification.status}`);
        
        if (record.locationVerification.proximity) {
          console.log(`   ðŸ“ Proximity Distance: ${record.locationVerification.proximity.distance || 'N/A'}m`);
          console.log(`   ðŸ“ Max Allowed: ${record.locationVerification.proximity.maxAllowed || 'N/A'}m`);
          console.log(`   âœ… Within Range: ${record.locationVerification.proximity.isWithinRange ? 'Yes' : 'No'}`);
        }
      } else {
        console.log('   âŒ Missing location verification data');
        validationErrors++;
      }
      
      // Check Metadata
      if (record.metadata) {
        try {
          const locationMeta = JSON.parse(record.metadata.location || '{}');
          if (locationMeta.qrScanner) {
            console.log('   ðŸ“Š Location metadata: âœ… Valid');
          }
          
          if (record.metadata.qrCode) {
            const qrMeta = JSON.parse(record.metadata.qrCode);
            console.log(`   ðŸŽ¯ QR Code ID: ${qrMeta.qrCodeId || 'N/A'}`);
            console.log(`   ðŸ‘¨â€ðŸ« Generated By: ${qrMeta.generatedBy || 'N/A'}`);
            console.log(`   ðŸ“… Generated At: ${qrMeta.generatedAt ? new Date(qrMeta.generatedAt).toLocaleString() : 'N/A'}`);
          }
        } catch (metaError) {
          console.log('   âš ï¸ Error parsing metadata:', metaError.message);
        }
      } else {
        console.log('   âŒ Missing metadata');
        validationErrors++;
      }
      
      console.log('   ' + '-'.repeat(50));
    });
    
    // Summary
    console.log('\nðŸ“ˆ Validation Summary:');
    console.log(`   ðŸ“„ Total Records: ${qrAttendanceRecords.length}`);
    console.log(`   âœ… Valid Records: ${qrAttendanceRecords.length - validationErrors}`);
    console.log(`   âŒ Records with Issues: ${validationErrors}`);
    
    // Test recent activity
    const today = new Date().toISOString().split('T')[0];
    const todayRecords = await Attendance.find({
      Date: { 
        $gte: new Date(today + 'T00:00:00.000Z'),
        $lt: new Date(today + 'T23:59:59.999Z')
      },
      attendanceType: 'qr_scan'
    });
    
    console.log(`\nðŸ“Š Today's QR Attendance Activity:`);
    console.log(`   ðŸ“„ Records Today: ${todayRecords.length}`);
    console.log(`   ðŸ‘¥ Unique Students: ${[...new Set(todayRecords.map(r => r.StudentID))].length}`);
    
    // Check for Socket.IO integration readiness
    console.log(`\nðŸ”Œ Real-time Integration Status:`);
    console.log(`   ðŸ“¡ Records have timestamps: ${qrAttendanceRecords.every(r => r.createdAt) ? 'âœ…' : 'âŒ'}`);
    console.log(`   ðŸŽ¯ Records have attendance type: ${qrAttendanceRecords.every(r => r.attendanceType) ? 'âœ…' : 'âŒ'}`);
    console.log(`   ðŸ“ Records have location data: ${qrAttendanceRecords.every(r => r.qrScannerLocation?.coordinates) ? 'âœ…' : 'âŒ'}`);
    
    const success = validationErrors === 0;
    
    if (success) {
      console.log('\nðŸŽ‰ All attendance records are properly formatted and ready for deployment!');
      console.log('\nðŸ“‹ Database is ready for:');
      console.log('   â€¢ Real-time QR attendance scanning');
      console.log('   â€¢ Socket.IO live updates');
      console.log('   â€¢ Admin dashboard integration');
      console.log('   â€¢ Location-based verification');
    } else {
      console.log('\nâš ï¸ Some records have validation issues. Check the output above.');
    }
    
    return success;
    
  } catch (error) {
    console.error('âŒ Error verifying attendance records:', error.message);
    return false;
  } finally {
    await mongoose.disconnect();
    console.log('\nðŸ”š Disconnected from MongoDB');
  }
}

// Run verification
if (require.main === module) {
  verifyAttendanceRecords().then(success => {
    process.exit(success ? 0 : 1);
  }).catch(error => {
    console.error('ðŸ’¥ Verification failed:', error);
    process.exit(1);
  });
}

module.exports = { verifyAttendanceRecords };
